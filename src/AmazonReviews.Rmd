---
title: "AmazonReviews"
author: "Kevin Kraayeveld (589908)"
date: "2024-03-13"
output: html_document
---

```{r setup, include=FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)

# List of required packages
packages <- c("data.table", "parallel")

# Check if each package is installed, if not, install it
for (package in packages) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
}

library(data.table)
library(parallel)

num_cores <- detectCores()

setDTthreads(threads = num_cores)

readRenviron("../.env")
python_path <- Sys.getenv("PYTHON_PATH")
```

```{r config, echo = FALSE, warning = FALSE}
get_new_data <- T

# Choose preprocessing method
# - "complete_cleaning"
# - "no_stemming"
# - "minimal_cleaning"

preprocessing_method <- "complete_cleaning"

small_data <- F

# Choose embedding model. The choices are:
# - "word2vec_cbow"
# - "word2vec_skipgram"
# - "GloVe"
# - "fastText"
# - "BERT"
# - "ELMO"
# - "pretrained_word2vec"
# - "pretrained_glove"
# - "pretrained_fasttext"
embedding_model <- "word2vec_cbow"
# If you want to run the embeddings file to get new embeddings this is TRUE. 
# This has to be True for pretrained models
get_new_embeddings <- T

create_new_vectors <- T
# Choose vectorization method
# - average
# - stacked
# - add
vectorization_method <- "average"

# Choose prediction model. The choices are:
# - "logistic_regression"
# - "ridge_regression"
prediction_model <- "logistic_regression"
# If you want to run the prediction file to get new predictions this is TRUE. 
# If you have the predictions saved in an Rds file then this is FALSE.
get_new_predictions <- TRUE
```

## Data preprocessing

```{r read_cleaned_data, echo = FALSE, warning = FALSE}
if(get_new_data){
  path <- paste0("Preprocessing/", preprocessing_method, ".R")
  source(path)
} else if(!get_new_data & (get_new_predictions | create_new_vectors)){
  if(small_data){
    file_path_train <- paste0("../data/Cleaned-Reviews/", preprocessing_method, "_train_small.csv")
    df <- fread(file_path_train)
    file_path_test <- paste0("../data/Cleaned-Reviews/", preprocessing_method, "_test_small.csv")
    test <- fread(file_path_test)
  } else{
    file_path_train <- paste0("../data/Cleaned-Reviews/", preprocessing_method, "_train.csv")
    df <- fread(file_path_train)
    file_path_test <- paste0("../data/Cleaned-Reviews/", preprocessing_method, "_test.csv")
    test <- fread(file_path_test)
  }
  # Splitting the Tokens column into a list of characters
  df$Review_Tokens <- strsplit(df$Review_Tokens, "\\|")
  test$Review_Tokens <- strsplit(test$Review_Tokens, "\\|")
}
```

## Embedding model

```{r embedding_model, echo = FALSE, warning = FALSE, include = FALSE}
if(get_new_embeddings){
  file_name <- paste0(embedding_model, ".R")
  path <- paste0("Embedding-Models/", file_name)
  source(path)
} else{
  if(small_data){
    file_name <- paste0(embedding_model, "_small.rds")
  } else{
    file_name <- paste0(embedding_model, ".rds")
  }
  path <- paste0("../data/Models/", file_name)
  model <- readRDS(path)
}
```

## Review vectorization

```{r review_vectorization, echo = FALSE, warning = FALSE}
if((!(tolower(embedding_model) %in% tolower(c("ELMo", "BERT"))))){
  if(create_new_vectors){
    file_name <- paste0(vectorization_method, "_vectorization.R")
    path <- paste0("Review-Vectorization/", file_name)
    source(path)
    if(small_data){
      path2 <- paste0("../data/Vectorized-Reviews/", vectorization_method,"_", embedding_model, "train_small.csv")
      path3 <- paste0("../data/Vectorized-Reviews/", vectorization_method,"_", embedding_model, "test_small.csv")
    }else{
      path2 <- paste0("../data/Vectorized-Reviews/", vectorization_method,"_", embedding_model, "train.csv")
      path3 <- paste0("../data/Vectorized-Reviews/", vectorization_method,"_", embedding_model, "test.csv")
    }
    fwrite(df, path2)
    fwrite(test, path3)
    } else{
      if(small_data){
        file_name <- paste0(vectorization_method, "_", embedding_model, "train_small.csv")
        file_name2 <- paste0(vectorization_method, "_", embedding_model, "test_small.csv")
      }else{
        file_name <- paste0(vectorization_method, "_", embedding_model, "train.csv")
        file_name2 <- paste0(vectorization_method, "_", embedding_model, "test.csv")
      }
    path <- paste0("../data/Vectorized-Reviews/", file_name)
    df <- fread(path)
    df$Review_Vector <- strsplit(df$Review_Vector, "\\|")
    df$Review_Vector <- lapply(df$Review_Vector, function(x) as.numeric(x))
    path2 <- paste0("../data/Vectorized-Reviews/", file_name2)
    test <- fread(path2)
    test$Review_Vector <- strsplit(test$Review_Vector, "\\|")
    test$Review_Vector <- lapply(test$Review_Vector, function(x) as.numeric(x))
    }
}
```

## Prediction model

```{r prediction_model, echo = FALSE, warning = FALSE}
if(get_new_predictions){
  file_name <- paste0(prediction_model, ".R")
  path <- paste0("Prediction-Models/", file_name)
  source(path)
} else{
  file_name <- paste0(prediction_model, ".Rdata")
  path <- paste0("Prediction-Models/", file_name)
  load(path)
}
```

## Evaluation

```{r evaluation, echo = FALSE, warning = FALSE}
source("Evaluation/Evaluation.R")
```