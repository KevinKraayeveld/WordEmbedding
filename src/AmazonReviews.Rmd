---
title: "AmazonReviews"
author: "Kevin Kraayeveld (589908)"
date: "2024-03-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# List of required packages
packages <- c("data.table", "parallel")

# Check if each package is installed, if not, install it
for (package in packages) {
  if (!requireNamespace(package, quietly = TRUE)) {
    install.packages(package)
  }
}

library(data.table)
library(parallel)

num_cores <- detectCores()

setDTthreads(threads = num_cores)
```

```{r config, echo = FALSE}
get_new_data <- T

# Choose embedding model. The choices are:
# - "word2vec_cbow"
# - "word2vec_skipgram"
# - "GloVe"
embedding_model <- "word2vec_cbow"
# If you want to run the embeddings file to get new embeddings this is TRUE. 
# If you have the model saved in a Rdata file then this is FALSE.
get_new_embeddings <- T

create_new_vectors <- TRUE
# Choose vectorization method
# - average
# - stacked (not yet)
vectorization_method <- "average"

# Choose prediction model. The choices are:
# - "logistic_regression"
prediction_model <- "logistic_regression"
# If you want to run the prediction file to get new predictions this is TRUE. 
# If you have the predictions saved in an Rdata file then this is FALSE.
get_new_predictions <- TRUE
```

## Data preprocessing

```{r read_cleaned_data, echo = FALSE}
if(get_new_data){
  source("Preprocessing/Cleaning.R")
} else if(!get_new_data & (get_new_predictions | create_new_vectors)){
  df <- fread("../data/tokenized_reviews.csv")
  # Splitting the Tokens column into a list of characters
  df$Review_Tokens <- strsplit(df$Review_Tokens, "\\|")
  df$Token_index <- lapply(strsplit(df$Token_index, "\\|"), as.numeric)
}
```

## Embedding model

```{r embedding_model, echo = FALSE}
if(get_new_embeddings){
  file_name <- paste0(embedding_model, ".R")
  path <- paste0("Embedding-Models/", file_name)
  source(path)
} else{
  file_name <- paste0(embedding_model, ".rds")
  path <- paste0("../data/Models/", file_name)
  model <- readRDS(path)
}

df[, Review_Tokens := NULL]
```

## Review vectorization

```{r review_vectorization, echo = FALSE}
if(create_new_vectors){
  file_name <- paste0(vectorization_method, "_vectorization.R")
  path <- paste0("Review-Vectorization/", file_name)
  source(path)
  path2 <-  paste0("../data/Vectorized-Reviews/vectorized_", embedding_model, ".csv")
  fwrite(df, path2)
} else{
  file_name <- paste0("vectorized_", embedding_model, ".csv")
  path <- paste0("../data/Vectorized-Reviews/", file_name)
  df <- fread(path)
  df$Review_Vector <- strsplit(df$Review_Vector, "\\|")
  df$Review_Vector <- lapply(df$Review_Vector, function(x) as.numeric(x))
}
```

## Prediction model

```{r prediction_model, echo = FALSE}
if(get_new_predictions){
  file_name <- paste0(prediction_model, ".R")
  path <- paste0("Prediction-Models/", file_name)
  source(path)
} else{
  file_name <- paste0(prediction_model, ".Rdata")
  path <- paste0("Prediction-Models/", file_name)
  load(path)
}
```

## Evaluation

```{r evaluation, echo = FALSE}
source("Evaluation/Evaluation.R")
```